<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificador de Status - TeleMed</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen py-8">
    <div class="max-w-2xl mx-auto px-4">
        <h1 class="text-3xl font-bold text-center mb-8">üîç Verificador de Status</h1>
        
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Status do Sistema</h2>
            <div id="statusResults" class="space-y-3"></div>
            <button id="checkStatus" class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
                üîÑ Verificar Status
            </button>
        </div>
        
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4">Pr√≥ximos Passos</h2>
            <div id="recommendations" class="space-y-2"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase.js"></script>
    <script>
        function addStatus(title, status, message, type = 'info') {
            const container = document.getElementById('statusResults');
            const div = document.createElement('div');
            
            const colors = {
                success: 'bg-green-50 border-green-200 text-green-800',
                error: 'bg-red-50 border-red-200 text-red-800',
                warning: 'bg-yellow-50 border-yellow-200 text-yellow-800',
                info: 'bg-blue-50 border-blue-200 text-blue-800'
            };
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            div.className = `p-4 rounded-lg border ${colors[type]}`;
            div.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <span class="mr-2 text-lg">${icons[type]}</span>
                        <span class="font-semibold">${title}</span>
                    </div>
                    <span class="text-sm font-medium">${status}</span>
                </div>
                <p class="mt-2 text-sm">${message}</p>
            `;
            container.appendChild(div);
        }
        
        function addRecommendation(text, priority = 'normal') {
            const container = document.getElementById('recommendations');
            const div = document.createElement('div');
            
            const priorityColors = {
                high: 'bg-red-50 border-red-200 text-red-800',
                normal: 'bg-blue-50 border-blue-200 text-blue-800',
                low: 'bg-gray-50 border-gray-200 text-gray-800'
            };
            
            div.className = `p-3 rounded border ${priorityColors[priority]}`;
            div.innerHTML = `<span class="text-sm">${text}</span>`;
            container.appendChild(div);
        }
        
        async function checkSystemStatus() {
            document.getElementById('statusResults').innerHTML = '';
            document.getElementById('recommendations').innerHTML = '';
            
            let canSignUp = false;
            let canSignIn = false;
            let dbConnected = false;
            
            try {
                // 1. Verificar inicializa√ß√£o do Supabase
                if (supabase) {
                    addStatus('Supabase Client', 'OK', 'Cliente inicializado corretamente', 'success');
                } else {
                    addStatus('Supabase Client', 'ERRO', 'Cliente n√£o inicializado', 'error');
                    return;
                }
                
                // 2. Verificar conex√£o com banco
                try {
                    const { data, error } = await supabase
                        .from('users')
                        .select('count', { count: 'exact', head: true });
                    
                    if (error) {
                        addStatus('Conex√£o BD', 'ERRO', `Erro: ${error.message}`, 'error');
                    } else {
                        addStatus('Conex√£o BD', 'OK', 'Banco de dados acess√≠vel', 'success');
                        dbConnected = true;
                    }
                } catch (e) {
                    addStatus('Conex√£o BD', 'ERRO', `Erro de conex√£o: ${e.message}`, 'error');
                }
                
                // 3. Verificar rate limiting para signup
                try {
                    // Tentar uma opera√ß√£o que n√£o consome rate limit
                    const { data: { session } } = await supabase.auth.getSession();
                    addStatus('Auth Session', 'OK', session ? `Logado: ${session.user.email}` : 'N√£o logado', 'info');
                    
                    // Simular verifica√ß√£o de rate limit (n√£o podemos testar diretamente sem consumir)
                    const now = Date.now();
                    const lastAttempt = localStorage.getItem('lastSignUpAttempt');
                    
                    if (lastAttempt) {
                        const timeSince = now - parseInt(lastAttempt);
                        const minutesSince = Math.floor(timeSince / (1000 * 60));
                        
                        if (minutesSince < 15) {
                            addStatus('Rate Limit', 'BLOQUEADO', `Aguarde ${15 - minutesSince} minutos para cadastro`, 'warning');
                            canSignUp = false;
                        } else {
                            addStatus('Rate Limit', 'OK', 'Pronto para cadastro', 'success');
                            canSignUp = true;
                        }
                    } else {
                        addStatus('Rate Limit', 'OK', 'Nenhuma tentativa recente detectada', 'success');
                        canSignUp = true;
                    }
                    
                } catch (e) {
                    addStatus('Auth Check', 'ERRO', `Erro: ${e.message}`, 'error');
                }
                
                // 4. Verificar pol√≠ticas RLS
                try {
                    // Tentar acessar a tabela (isso indica se as pol√≠ticas est√£o OK)
                    const { data, error } = await supabase
                        .from('users')
                        .select('id')
                        .limit(1);
                    
                    // Se n√£o der erro de pol√≠tica, est√° OK
                    addStatus('Pol√≠ticas RLS', 'OK', 'Pol√≠ticas de seguran√ßa configuradas', 'success');
                } catch (e) {
                    addStatus('Pol√≠ticas RLS', 'AVISO', 'N√£o foi poss√≠vel verificar pol√≠ticas', 'warning');
                }
                
            } catch (error) {
                addStatus('Sistema', 'ERRO', `Erro geral: ${error.message}`, 'error');
            }
            
            // Gerar recomenda√ß√µes
            if (!dbConnected) {
                addRecommendation('üîß Verifique a conex√£o com o Supabase', 'high');
            }
            
            if (!canSignUp) {
                addRecommendation('‚è∞ Aguarde o reset do rate limit ou use emails √∫nicos em test-signup.html', 'high');
                addRecommendation('üß™ Enquanto isso, teste outras funcionalidades em test-auth.html', 'normal');
            } else {
                addRecommendation('‚úÖ Sistema pronto! Voc√™ pode testar cadastro em auth.html', 'normal');
                addRecommendation('üöÄ Execute todos os testes em test-auth.html', 'normal');
            }
            
            addRecommendation('üìã Consulte VALIDATION_CHECKLIST.md para lista completa de funcionalidades', 'low');
        }
        
        document.getElementById('checkStatus').addEventListener('click', checkSystemStatus);
        
        // Verificar status automaticamente ao carregar
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(checkSystemStatus, 1000);
        });
    </script>
</body>
</html>